<div class="carpeta-container">
    <!-- Indicador de carga -->
    <div *ngIf="loading" class="loading-overlay">
      <div class="loading-indicator">
        <div class="spinner"></div>
        <p>Cargando...</p>
      </div>
    </div>
    
    <!-- Mensaje de error -->
    <div *ngIf="error" class="error-message">
      <p>{{ error }}</p>
      <button class="btn-close" (click)="error = ''">√ó</button>
    </div>
    
    <!-- Si hay carpeta existente, mostrar contenido -->
    <ng-container *ngIf="carpeta">
      <!-- Informaci√≥n de la carpeta -->
      <div class="carpeta-header">
        <div class="header-content">
          <h3>Im√°genes del Paciente</h3>
          <p class="carpeta-descripcion">{{ carpeta.descripcion }}</p>
        </div>
      </div>
      
      <!-- Galer√≠a de im√°genes con acciones integradas -->
      <div class="card gallery-section">
        <div class="card-header">
          <h4>Galer√≠a de Im√°genes</h4>
        </div>
        <div class="card-body">
          <!-- Panel de acciones siempre visible -->
          <div class="gallery-actions">
            <button class="btn btn-upload" (click)="mostrarFormularioSubida = !mostrarFormularioSubida">
              {{ mostrarFormularioSubida ? '‚Üê Ocultar formulario' : '+ Nueva imagen' }}
            </button>
          </div>
  
          <!-- Formulario de carga condicional -->
          <div *ngIf="mostrarFormularioSubida" class="upload-mini-form">
            <div class="form-group">
              <label for="fileInputGallery">Seleccionar imagen:</label>
              <div class="file-input-wrapper">
                <input 
                  type="file" 
                  id="fileInputGallery" 
                  accept="image/jpeg, image/png" 
                  (change)="onFileSelected($event)"
                >
                <label for="fileInputGallery" class="file-input-label">
                  <i class="upload-icon"></i> Seleccionar archivo
                </label>
              </div>
              <span *ngIf="archivoSeleccionado" class="selected-file">
                <i class="file-icon"></i>
                {{ archivoSeleccionado.name }} ({{ (archivoSeleccionado.size / 1024).toFixed(2) }} KB)
              </span>
            </div>
            
            <div class="form-group">
              <label for="descripcionInputGallery">Descripci√≥n:</label>
              <input 
                type="text" 
                id="descripcionInputGallery" 
                placeholder="Describa la imagen..." 
                [(ngModel)]="descripcionImagen"
                class="form-control"
              >
            </div>
            
            <button class="btn btn-upload" (click)="subirImagen()" [disabled]="!archivoSeleccionado">
              <i class="upload-icon"></i> Subir
            </button>
          </div>
  
          <!-- Mensaje cuando no hay im√°genes -->
          <div *ngIf="imagenes.length === 0" class="no-images">
            <div class="empty-state">
              <div class="empty-icon">üñºÔ∏è</div>
              <p>No hay im√°genes en la carpeta</p>
              <span>Agregue im√°genes usando el bot√≥n "Nueva imagen"</span>
            </div>
          </div>
          
          <!-- Grid de im√°genes -->
          <div *ngIf="imagenes.length > 0" class="gallery-grid">
            <div *ngFor="let imagen of imagenes" class="image-card">
              <div class="image-container" (click)="verImagen(imagen)">
                <img 
                  [src]="getImageUrl(imagen.ruta)" 
                  [alt]="imagen.descripcion || 'Imagen del paciente'"
                  (error)="handleImageError($event)"
                >
                <div class="image-overlay">
                  <span class="view-icon">üîç</span>
                </div>
              </div>
              <div class="image-info">
                <p *ngIf="imagen.descripcion" class="image-description" [title]="imagen.descripcion">
                  {{ imagen.descripcion.length > 30 ? (imagen.descripcion | slice:0:27) + '...' : imagen.descripcion }}
                </p>
                <p class="image-date">
                  <i class="calendar-icon"></i>
                  {{ obtenerFechaFormateada(imagen.fecha_subida) }}
                </p>
                <button class="btn-delete" (click)="$event.stopPropagation(); eliminarImagen(imagen)" title="Eliminar imagen">
                  <i class="delete-icon"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
    
    <!-- Si NO hay carpeta, mostrar formulario de creaci√≥n -->
    <div *ngIf="!carpeta && !loading" class="card create-carpeta-card">
      <div class="card-header">
        <h3>Crear Carpeta de Im√°genes</h3>
      </div>
      <div class="card-body">
        <div class="empty-state">
          <div class="folder-icon">üìÅ</div>
          <p>Este paciente a√∫n no tiene una carpeta de im√°genes</p>
          <div class="create-form">
            <div class="form-group">
              <label for="nombreCarpeta">Nombre de la carpeta:</label>
              <input 
                type="text" 
                id="nombreCarpeta" 
                class="form-control" 
                placeholder="Ej: Procedimiento facial, Im√°genes de seguimiento..."
                [(ngModel)]="nuevaCarpetaNombre"
              >
            </div>
            <button class="btn btn-create" (click)="crearCarpeta()">
              <i class="folder-plus-icon"></i> Crear Carpeta
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Vista previa ampliada de imagen -->
    <div *ngIf="imagenSeleccionada" class="image-preview-overlay" (click)="cerrarVistaPrevia()">
      <div class="image-preview-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ imagenSeleccionada.descripcion || 'Imagen del paciente' }}</h2>
          <button class="btn-close" (click)="cerrarVistaPrevia()">&times;</button>
        </div>
        <div class="modal-body">
          <img 
            [src]="getImageUrl(imagenSeleccionada.ruta)" 
            [alt]="imagenSeleccionada.descripcion || 'Imagen del paciente'"
            (error)="handleImageError($event)"
          >
          <div class="modal-info">
            <div class="info-item">
              <span class="info-label">Fecha:</span>
              <span class="info-value">{{ obtenerFechaFormateada(imagenSeleccionada.fecha_subida) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Archivo:</span>
              <span class="info-value">{{ imagenSeleccionada.nombre_archivo }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>